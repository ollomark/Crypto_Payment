
@{
    ViewBag.Title = "title";
    Layout = "_AuthLayout";
}

<div class="card">
    <div class="card-body">
        <h5 class="mb-3">Google Authenticator Kurulumu</h5>

        <div id="setupLoading">Yükleniyor...</div>

        <div id="setupBox" style="display:none;">
            <p class="mb-2">Uygulamadan QR kodu okutun:</p>
            <img id="qrImg" style="max-width:220px;" />

            <div class="mt-3">
                <p class="mb-1">QR okuyamıyorsanız manuel kod:</p>
                <code id="sharedKey"></code>
            </div>

            <hr class="my-4" />

            <form id="enable2faForm" class="needs-validation" novalidate>
                <label class="form-label">Uygulamadaki 6 haneli kod</label>
                <input id="totpCode" class="form-control" required placeholder="123456" />
                <div class="invalid-feedback">Kod giriniz</div>

                <div id="enableError" class="alert alert-danger mt-3 d-none"></div>

                <button class="btn btn-success mt-3" type="submit">2FA’yı Aktif Et</button>
            </form>

            <div id="recoveryBox" class="mt-4 d-none">
                <h6>Kurtarma Kodları (sakla!)</h6>
                <pre id="recoveryCodes" class="p-3 bg-light rounded"></pre>
            </div>
        </div>
    </div>
</div>

<script>
(async () => {
  const loading = document.getElementById("setupLoading");
  const box = document.getElementById("setupBox");
  const qrImg = document.getElementById("qrImg");
  const sharedKeyEl = document.getElementById("sharedKey");

  // 1) Setup bilgilerini al
  const res = await fetch("/api/auth/2fa/setup");
  if (!res.ok) {
    loading.innerText = "2FA kurulumu alınamadı.";
    return;
  }
  const data = await res.json();

  qrImg.src = data.qrCodeBase64;
  sharedKeyEl.innerText = data.sharedKey;

  loading.style.display = "none";
  box.style.display = "block";

  // 2) Enable formu
  const form = document.getElementById("enable2faForm");
  const errorBox = document.getElementById("enableError");
  const recoveryBox = document.getElementById("recoveryBox");
  const recoveryCodesEl = document.getElementById("recoveryCodes");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();
    errorBox.classList.add("d-none");
    errorBox.innerText = "";

    if (!form.checkValidity()) {
      form.classList.add("was-validated");
      return;
    }

    const code = document.getElementById("totpCode").value.trim();

    const r2 = await fetch("/api/auth/2fa/enable", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    });

    const body = await r2.json().catch(() => ({}));

    if (!r2.ok) {
      errorBox.innerText = body.title ?? "Kod doğrulanamadı.";
      errorBox.classList.remove("d-none");
      return;
    }

    // başarılı → recovery codes göster
    recoveryBox.classList.remove("d-none");
    recoveryCodesEl.innerText = (body.recoveryCodes ?? []).join("\n");
  });
})();
</script>

